{"version":3,"file":"","sourceRoot":"","sources":["app.js","pages/index/index.js","pages/course-detail/detail.js","pages/checkout/checkout.js","pages/my-courses/my-courses.js","pages/profile/profile.js","pages/lesson/lesson.js"],"names":["App","globalData","openid","version","mockPay","onLaunch","wx","cloud","init","env","DYNAMIC_CURRENT_ENV","traceUser","cached","getStorageSync","this","console","error","ensureOpenid","_this","_asyncToGenerator2","_regeneratorRuntime2","mark","_callee","_r$result","r","wrap","_context","prev","next","abrupt","callFunction","name","sent","result","setStorageSync","stop","Page","data","courses","onLoad","showLoading","title","then","res","setData","catch","err","showToast","icon","finally","hideLoading","goDetail","e","id","currentTarget","dataset","navigateTo","url","courseId","course","lessons","options","loadCourse","db","courseRes","lessonsRes","database","collection","doc","get","where","orderBy","t0","finish","goCheckout","goLesson","_e$currentTarget$data","concat","app","getApp","isPaid","orderId","outTradeNo","paying","query","_this2","_callee2","yuan","_context2","price","toFixed","_objectSpread2","displayPrice","createOrder","_this3","_callee3","cr","raw","norm","msg","_context3","log","code","ok","message","detail","JSON","stringify","devMock","normalize","showModal","content","showCancel","_markPaidDev","setTimeout","redirectTo","requestPayment","timeStamp","nonceStr","package","signType","paySign","_waitPaid","errMsg","_ref","_callee4","_context4","warn","_ref2","_this4","_callee7","tries","checkOnce","loop","_context7","_ref3","_callee5","paid","od","_r","_context5","status","apply","arguments","_ref4","_callee6","_context6","list","loading","empty","onShow","loadPurchased","_","or","orders","ids","cmap","command","_openid","length","map","o","filter","Boolean","_id","in","forEach","c","paidAt","createdAt","brief","user","editMode","got","onGetUserProfile","_success","getUserProfile","desc","success","nickName","avatarUrl","userInfo","set","Date","update","_x","fail","reAuth","remove","toggleEdit","onChooseAvatar","onNickInput","value","saveProfile","updatedAt","goMyCourses","lessonId","videoUrl","authorized","loadVideo"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;6HAAA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","sourcesContent":["App({\n  globalData: { openid: '', version: '0.2.0', mockPay: true },\n\n  onLaunch() {\n    if (!wx.cloud) {\n      console.error('请使用 2.2.3+ 基础库');\n      return;\n    }\n    // 绑定到项目当前环境，无需手动写 envId\n    wx.cloud.init({ env: wx.cloud.DYNAMIC_CURRENT_ENV, traceUser: true });\n\n    // 可选：从本地恢复 openid，减少云函数调用\n    const cached = wx.getStorageSync('openid');\n    if (cached) this.globalData.openid = cached;\n  },\n\n  // 全局确保拿到 openid，并缓存\n  async ensureOpenid() {\n    if (this.globalData.openid) return this.globalData.openid;\n    const r = await wx.cloud.callFunction({ name: 'login' });\n    const openid = r?.result?.openid || '';\n    this.globalData.openid = openid;\n    if (openid) wx.setStorageSync('openid', openid);\n    return openid;\n  }\n});\n","Page({\n  data: {\n    courses: []\n  },\n  onLoad() {\n    wx.showLoading({ title: '加载中...' });\n    wx.cloud.callFunction({\n      name: 'listCourses',\n    }).then(res => {\n      this.setData({ courses: res.result || [] });\n    }).catch(err => {\n      console.error(err);\n      wx.showToast({ title: '加载失败', icon: 'none' });\n    }).finally(() => {\n      wx.hideLoading();\n    });\n  },\n  goDetail(e) {\n    const id = e.currentTarget.dataset.id;\n    wx.navigateTo({\n      url: '/pages/course-detail/detail?courseId=' + id,\n    });\n  },\n});","Page({\n  data: {\n    courseId: '',\n    course: {},\n    lessons: []\n  },\n  onLoad(options) {\n    const { courseId } = options;\n    this.setData({ courseId });\n    this.loadCourse(courseId);\n  },\n  async loadCourse(id) {\n    const db = wx.cloud.database();\n    wx.showLoading({ title: '加载中...' });\n    try {\n      const courseRes = await db.collection('courses').doc(id).get();\n      const lessonsRes = await db.collection('lessons')\n        .where({ courseId: id })\n        .orderBy('order', 'asc')\n        .get();\n      this.setData({\n        course: courseRes.data,\n        lessons: lessonsRes.data,\n      });\n    } catch (e) {\n      console.error(e);\n      wx.showToast({ title: '加载失败', icon: 'none' });\n    } finally {\n      wx.hideLoading();\n    }\n  },\n  goCheckout() {\n    wx.navigateTo({ url: '/pages/checkout/checkout?courseId=' + this.data.courseId });\n  },\n  goLesson(e) {\n    const { id, title } = e.currentTarget.dataset;\n    wx.navigateTo({\n      url: `/pages/lesson/lesson?courseId=${this.data.courseId}&lessonId=${id}&title=${title}`,\n    });\n  },\n});","// miniprogram/pages/checkout/checkout.js\nconst app = getApp();\n\nPage({\n  data: {\n    courseId: '',\n    course: null,\n    isPaid: false,\n    orderId: '',\n    outTradeNo: '',\n    paying: false\n  },\n\n  async onLoad(query) {\n    const courseId = (query && query.courseId) || '';\n    if (!courseId) {\n      wx.showToast({ title: '缺少课程ID', icon: 'none' });\n      return;\n    }\n    this.setData({ courseId });\n    await this.loadCourse();\n  },\n\n  async loadCourse() {\n    try {\n      wx.showLoading({ title: '加载中...' });\n      const db = wx.cloud.database();\n      const r = await db.collection('courses').doc(this.data.courseId).get();\n      const yuan = ((r.data && r.data.price ? r.data.price : 0) / 100).toFixed(2);\n      this.setData({ course: { ...r.data, displayPrice: yuan } });\n    } catch (e) {\n      console.error(e);\n      wx.showToast({ title: '课程加载失败', icon: 'none' });\n    } finally {\n      wx.hideLoading();\n    }\n  },\n\n  async createOrder() {\n    if (this.data.paying) return;\n    this.setData({ paying: true });\n\n    let cr = null;\n    try {\n      const openid = await app.ensureOpenid();\n      if (!openid) { wx.showToast({ title: '请先登录', icon: 'none' }); return; }\n\n      wx.showLoading({ title: '下单中...' });\n\n      cr = await wx.cloud.callFunction({\n        name: 'createOrder',\n        data: { courseId: this.data.courseId }\n      });\n\n      const raw = (cr && cr.result) || {};\n      console.log('createOrder raw ->', raw);\n\n      // 兼容两种返回：{code:0,data:{...}} 或 直接 {orderId,outTradeNo,...}\n      const normalize = (r) => {\n        if (typeof r.code !== 'undefined') {\n          if (r.code === 0 && r.data) return { ok: true, data: r.data };\n          return { ok: false, msg: r.message || (r.detail ? JSON.stringify(r.detail) : JSON.stringify(r)) };\n        }\n        if (r && (r.orderId || r.outTradeNo)) {\n          return { ok: true, data: { ...r, devMock: (typeof r.devMock === 'boolean' ? r.devMock : true) } };\n        }\n        return { ok: false, msg: JSON.stringify(r) };\n      };\n\n      const norm = normalize(raw);\n      if (!norm.ok) {\n        wx.showModal({ title: '下单失败', content: norm.msg || '未知原因', showCancel: false });\n        return;\n      }\n\n      const data = norm.data || {};\n      const outTradeNo = data.outTradeNo || '';\n      const orderId    = data.orderId || '';\n      this.setData({ outTradeNo, orderId });\n\n      // 开发/模拟：直接标记已支付\n      if (data.devMock || (app.globalData && app.globalData.mockPay)) {\n        await this._markPaidDev({ outTradeNo, orderId });\n        wx.hideLoading();\n        wx.showToast({ title: '支付成功（开发模式）' });\n        this.setData({ isPaid: true });\n        setTimeout(() => wx.redirectTo({ url: '/pages/my-courses/my-courses' }), 600);\n        return;\n      }\n\n      // 正式支付\n      wx.hideLoading();\n      await wx.requestPayment({\n        timeStamp: data.timeStamp,\n        nonceStr:  data.nonceStr,\n        package:   data.package,\n        signType:  data.signType || 'RSA',\n        paySign:   data.paySign\n      });\n\n      await this._waitPaid({ outTradeNo, orderId });\n\n    } catch (e) {\n      console.error('pay_error:', e, 'raw:', cr);\n      const msg = (e && (e.message || e.errMsg)) || '支付取消/失败';\n      wx.showToast({ title: msg, icon: 'none' });\n    } finally {\n      wx.hideLoading();\n      this.setData({ paying: false });\n    }\n  },\n\n  // ===== helpers =====\n  // 开发模式：调用后端 markOrderPaid，将订单置为 paid\n  async _markPaidDev({ outTradeNo, orderId }) {\n    try {\n      const data = outTradeNo ? { outTradeNo } : { orderId };\n      await wx.cloud.callFunction({ name: 'markOrderPaid', data });\n    } catch (e) {\n      console.warn('markOrderPaid fail:', e);\n    }\n  },\n\n  // 轮询订单状态，等待回调把订单改为 paid\n  async _waitPaid({ outTradeNo, orderId }) {\n    wx.showLoading({ title: '确认支付中...' });\n    const db = wx.cloud.database();\n    let tries = 0;\n\n    const checkOnce = async () => {\n      tries++;\n      try {\n        let paid = false;\n        if (outTradeNo) {\n          const r = await db.collection('orders').where({ outTradeNo }).get();\n          const od = r.data && r.data[0];\n          paid = !!(od && od.status === 'paid');\n        } else if (orderId) {\n          const r = await db.collection('orders').doc(orderId).get();\n          paid = !!(r.data && r.data.status === 'paid');\n        }\n        if (paid) {\n          wx.hideLoading();\n          wx.showToast({ title: '支付成功' });\n          this.setData({ isPaid: true });\n          wx.redirectTo({ url: '/pages/my-courses/my-courses' });\n          return true;\n        }\n      } catch (e) {\n        console.warn('check order error:', e);\n      }\n      return false;\n    };\n\n    const loop = async () => {\n      const ok = await checkOnce();\n      if (ok) return;\n      if (tries < 10) setTimeout(loop, 1500);\n      else {\n        wx.hideLoading();\n        wx.showToast({ title: '未确认支付，可稍后在已购查看', icon: 'none' });\n      }\n    };\n    loop();\n  }\n});\n","const app = getApp()\n\nPage({\n  data: {\n    list: [],\n    loading: false,\n    empty: false\n  },\n\n  async onShow() { this.loadPurchased() },\n\n  async loadPurchased() {\n    try {\n      this.setData({ loading: true })\n      const openid = await app.ensureOpenid()\n      const db = wx.cloud.database()\n      const _ = db.command\n\n      // 1) 取已支付订单\n      const or = await db.collection('orders')\n        .where({ _openid: openid, status: 'paid' })\n        .orderBy('paidAt', 'desc')\n        .get()\n\n      const orders = or.data || []\n      if (!orders.length) { this.setData({ list: [], empty: true, loading: false }); return }\n\n      // 2) 批量取课程\n      const ids = orders.map(o => o.courseId).filter(Boolean)\n      const cr = await db.collection('courses').where({ _id: _.in(ids) }).get()\n      const cmap = {}\n      ;(cr.data || []).forEach(c => cmap[c._id] = c)\n\n      // 3) 组装展示\n      const list = orders.map(o => ({\n        orderId: o._id,\n        outTradeNo: o.outTradeNo,\n        paidAt: o.paidAt || o.createdAt,\n        courseId: o.courseId,\n        title: (cmap[o.courseId] && cmap[o.courseId].title) || '课程已下架',\n        brief: (cmap[o.courseId] && cmap[o.courseId].brief) || '',\n        price: (o.price || 0),\n        displayPrice: ((o.price || 0) / 100).toFixed(2)\n      }))\n\n      this.setData({ list, empty: false })\n    } catch (e) {\n      console.error(e)\n      wx.showToast({ title: '加载已购失败', icon: 'none' })\n    } finally {\n      this.setData({ loading: false })\n    }\n  },\n\n  goDetail(e) {\n    const id = e.currentTarget.dataset.id\n    if (!id) return\n    wx.navigateTo({ url: `/pages/course-detail/detail?id=${id}` })\n  }\n})\n","const app = getApp()\n\nPage({\n  data: {\n    user: null,\n    openid: '',\n    editMode: false\n  },\n\n  async onLoad() {\n    try {\n      const openid = await app.ensureOpenid()\n      this.setData({ openid })\n      const db = wx.cloud.database()\n      const got = await db.collection('users').doc(openid).get().catch(() => null)\n      if (got && got.data) this.setData({ user: got.data })\n    } catch (e) {\n      console.error(e)\n      wx.showToast({ title: '登录初始化失败', icon: 'none' })\n    }\n  },\n\n  // 微信授权：拿头像昵称并写入 users（docId = openid）\n  onGetUserProfile() {\n    wx.getUserProfile({\n      desc: '用于完善用户资料',\n      success: async (res) => {\n        const { nickName, avatarUrl } = res.userInfo || {}\n        const db = wx.cloud.database()\n        await db.collection('users').doc(this.data.openid).set({\n          data: { nickName, avatarUrl, createdAt: new Date() }\n        }).catch(async () => {\n          await db.collection('users').doc(this.data.openid).update({ data: { nickName, avatarUrl } })\n        })\n        this.setData({ user: { nickName, avatarUrl } })\n        wx.showToast({ title: '登录成功' })\n      },\n      fail: () => wx.showToast({ title: '已取消授权', icon: 'none' })\n    })\n  },\n\n  // 重新授权：删除当前资料 -> 触发一次授权\n  async reAuth() {\n    try {\n      const db = wx.cloud.database()\n      await db.collection('users').doc(this.data.openid).remove().catch(()=>{})\n      this.setData({ user: null, editMode: false })\n      this.onGetUserProfile()\n    } catch (e) {\n      console.error(e)\n      wx.showToast({ title: '重试失败', icon: 'none' })\n    }\n  },\n\n  // 编辑资料（不依赖微信昵称）\n  toggleEdit() { this.setData({ editMode: !this.data.editMode }) },\n  onChooseAvatar(e) {\n    const avatarUrl = e.detail.avatarUrl\n    this.setData({ user: { ...(this.data.user || {}), avatarUrl } })\n  },\n  onNickInput(e) {\n    const nickName = e.detail.value\n    this.setData({ user: { ...(this.data.user || {}), nickName } })\n  },\n  async saveProfile() {\n    try {\n      const db = wx.cloud.database()\n      await db.collection('users').doc(this.data.openid).set({\n        data: { ...(this.data.user || {}), updatedAt: new Date() }\n      }).catch(async () => {\n        await db.collection('users').doc(this.data.openid).update({ data: this.data.user })\n      })\n      wx.showToast({ title: '已保存' })\n      this.setData({ editMode: false })\n    } catch (e) {\n      console.error(e)\n      wx.showToast({ title: '保存失败', icon: 'none' })\n    }\n  },\n\n  goMyCourses() { wx.navigateTo({ url: '/pages/my-courses/my-courses' }) }\n})\n","Page({\n  data: {\n    courseId: '',\n    lessonId: '',\n    title: '',\n    videoUrl: '',\n    authorized: false\n  },\n  onLoad(options) {\n    const { courseId, lessonId, title } = options;\n    this.setData({ courseId, lessonId, title });\n    this.loadVideo();\n  },\n  loadVideo() {\n    wx.showLoading({ title: '加载视频...' });\n    wx.cloud.callFunction({\n      name: 'getLessonUrl',\n      data: {\n        courseId: this.data.courseId,\n        lessonId: this.data.lessonId\n      }\n    }).then(res => {\n      this.setData({\n        videoUrl: res.result.videoUrl,\n        authorized: true,\n      });\n    }).catch(err => {\n      console.error(err);\n      this.setData({ authorized: false });\n      wx.showToast({ title: '请先购买课程', icon: 'none' });\n    }).finally(() => {\n      wx.hideLoading();\n    });\n  }\n});"],"wx":{"version":1,"userVersion":"1.0.5","userNotes":"有脑子的小鹏 在 2025年8月13日上午11点01分 提交上传","packageVersion":"bbb7d13fe2bf3ba5f844ccc35693516b"}}