const cloud=require('wx-server-sdk'); cloud.init({ env:cloud.DYNAMIC_CURRENT_ENV }); exports.main=async(event)=>{ const {OPENID}=cloud.getWXContext(); const db=cloud.database(); const users=db.collection('users'); const now=new Date(); const data={ updatedAt:now }; if(event&&event.nickName!==undefined) data.nickName=event.nickName; if(event&&event.avatarUrl!==undefined) data.avatarUrl=event.avatarUrl; if(event&&event.phoneNumber!==undefined) data.phoneNumber=event.phoneNumber; try{ await users.doc(OPENID).update({ data }) }catch(e){ await users.doc(OPENID).set({ data:{ role:'buyer', createdAt:now, ...data } }) } const got=await users.doc(OPENID).get(); return { ok:true, user:got.data } }
